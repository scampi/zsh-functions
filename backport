BLACK='\033[30m'
RED='\033[31m'
GREEN='\033[32m'
END='\033[0m'

if [ $# -ne 4 ]; then
	echo "help: backport <branch> <issue> <start-commit> <end-commit>"
	echo "<branch> may be equal to master or integration instead of a version number."
	return 1
fi

# get the current branch name: https://stackoverflow.com/a/11868440
local original_branch=$(git rev-parse --abbrev-ref HEAD)
local branch=$1
local issue=$2
local start=$3
local end=$4

cecho() {
	local color=${2:-$BLACK}
	echo -e "${color}$1${END}"
}

if [[ $branch != "master" ]] && [[ $branch != "integration" ]]; then
	branch="branch-$branch"
fi

cecho "checkout branch $branch to backport" $GREEN
git checkout $branch
if [[ $? -ne 0 ]]; then
	cecho 'something has gone wrong!' $RED
	return 1
fi
echo

cecho 'update the branch' $GREEN
git pull
if [[ $? -ne 0 ]]; then
	cecho 'something has gone wrong!' $RED
	return 1
fi
echo

cecho "create branch BP-$branch-$issue for the commits to backport" $GREEN
git checkout -b BP-$branch-$issue
git cherry-pick -x $start~1..$end
if [[ $? -ne 0 ]]; then
	git mergetool
	if [[ $? -ne 0 ]]; then
		cecho 'something has gone wrong!' $RED
		return 1
	fi
	git cherry-pick --continue
fi
echo

local pr_body=$(printf "backport #$issue to $branch\n\nIssue #$issue")

cecho "check the branch compiles with new changes" $GREEN
mvn clean test-compile compile
if [[ $? -ne 0 ]]; then
	cecho 'something has gone wrong!' $RED
	cecho "Fix then create PR with: hub pull-request -m \"$pr_body\" -b $branch" $RED
	return 1
fi
echo

cecho "push the new branch" $GREEN
git push origin BP-$branch-$issue
if [[ $? -ne 0 ]]; then
	cecho 'something has gone wrong!' $RED
	return 1
fi
echo

cecho "create the pull request" $GREEN
hub pull-request -m "$pr_body" -b $branch
if [[ $? -ne 0 ]]; then
	cecho 'something has gone wrong!' $RED
	return 1
fi
echo

# go back to the original branch
git checkout $original_branch

# vim: set ts=4 sw=4 tw=0 ft=sh noet :
